# Vagrantfile
Vagrant.configure("2") do |config|
  # Box base para todas las m√°quinas
  config.vm.box = "debian/bookworm64"

  tu_nombre = "RicardoFrutos"   # Sustituye por tu alias
  base_net  = "10.10.10"

  # ---------------- Capa 1: Balanceador HTTP ----------------
  config.vm.define "balanceador#{tu_nombre}" do |vm|
    vm.vm.hostname = "balanceador#{tu_nombre}"
    vm.vm.network :private_network, ip: "#{base_net}.10"
    vm.vm.network :forwarded_port, guest: 80, host: 8080, auto_correct: true
    vm.vm.provider "virtualbox" do |vb|
      vb.memory = 1024
      vb.cpus   = 1
    end
    vm.vm.provision "shell", path: "provision/lb_nginx.sh", args: ["#{base_net}.21", "#{base_net}.22"]
  end

  # ---------------- Capa 2: Web servers ----------------
  config.vm.define "serverweb1#{tu_nombre}" do |vm|
    vm.vm.hostname = "serverweb1#{tu_nombre}"
    vm.vm.network :private_network, ip: "#{base_net}.21"
    vm.vm.provider "virtualbox" do |vb|
      vb.memory = 1024
      vb.cpus   = 1
    end
    vm.vm.provision "shell", path: "provision/web_nginx.sh", args: ["#{base_net}.30"]
  end

  config.vm.define "serverweb2#{tu_nombre}" do |vm|
    vm.vm.hostname = "serverweb2#{tu_nombre}"
    vm.vm.network :private_network, ip: "#{base_net}.22"
    vm.vm.provider "virtualbox" do |vb|
      vb.memory = 1024
      vb.cpus   = 1
    end
    vm.vm.provision "shell", path: "provision/web_nginx.sh", args: ["#{base_net}.30"]
  end

  # NFS + PHP-FPM
  config.vm.define "serverNFS#{tu_nombre}" do |vm|
    vm.vm.hostname = "serverNFS#{tu_nombre}"
    vm.vm.network :private_network, ip: "#{base_net}.30"
    vm.vm.provider "virtualbox" do |vb|
      vb.memory = 2048
      vb.cpus   = 2
    end
    vm.vm.provision "shell", path: "provision/nfs_php.sh", args: ["#{base_net}.21", "#{base_net}.22"]
  end

  # ---------------- Capa 3: HAProxy DB ----------------
  config.vm.define "proxyBBDD#{tu_nombre}" do |vm|
    vm.vm.hostname = "proxyBBDD#{tu_nombre}"
    vm.vm.network :private_network, ip: "#{base_net}.40"
    vm.vm.provider "virtualbox" do |vb|
      vb.memory = 1024
      vb.cpus   = 1
    end
    vm.vm.provision "shell", path: "provision/haproxy_db.sh", args: ["#{base_net}.50"]
  end

  # ---------------- Capa 4: MariaDB ----------------
  config.vm.define "serverdatos#{tu_nombre}" do |vm|
    vm.vm.hostname = "serverdatos#{tu_nombre}"
    vm.vm.network :private_network, ip: "#{base_net}.50"
    vm.vm.provider "virtualbox" do |vb|
      vb.memory = 2048
      vb.cpus   = 2
    end
    vm.vm.provision "shell", path: "provision/mariadb.sh", args: ["#{base_net}.40"]
  end
end

